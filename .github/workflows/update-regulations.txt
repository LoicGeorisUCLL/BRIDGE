# .github/workflows/update-regulations.yml
name: Update Bridge Regulations and Questions
on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      regulations_url:
        description: 'URL of the regulations HTML page'
        required: true
        default: 'bridgeregulations.up.railway.app'
  # Scheduled trigger (daily at 3 AM UTC)
  # schedule:
  #   - cron: '0 3 * * *'

env:
  REGULATIONS_URL: ${{ github.event.inputs.regulations_url || secrets.REGULATIONS_URL }}

jobs:
  update-regulations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          
      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          npm install -g tsx
          
      - name: ğŸ” Check for regulation changes
        id: check_changes
        run: |
          # Download current regulations and compare with last known state
          curl -s "$REGULATIONS_URL" > current_regulations.html
          
          if [ -f "previous_regulations.html" ]; then
            # Compare with previous version
            if diff -q current_regulations.html previous_regulations.html > /dev/null 2>&1; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "ğŸ“‹ No changes detected in regulations"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "ğŸ”„ Changes detected in regulations"
            fi
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ†• First run - processing regulations"
          fi
          
          # Save current state for next comparison
          cp current_regulations.html previous_regulations.html
          
      - name: ğŸ¤– Update questions and logic with new regulations
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ”„ Updating questions and logic based on new regulations..."
          tsx regulation-scraper.ts "$REGULATIONS_URL"
          
      - name: ğŸ“‹ Check generated files
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“‚ Files generated/updated:"
          
          if [ -f "public/locales/en/questions.json" ]; then
            echo "âœ… Questions file generated: public/locales/en/questions.json"
            echo "ğŸ“Š Number of questions: $(cat public/locales/en/questions.json | jq '.intakeQuestions | length')"
          else
            echo "âŒ Questions file not found!"
            exit 1
          fi
          
          if [ -f "components/logic/logic.tsx" ]; then
            echo "âœ… Logic file updated: components/logic/logic.tsx"
          else
            echo "âŒ Logic file not found!"
            exit 1
          fi
          
          if [ -f "regulation-metadata.json" ]; then
            echo "âœ… Metadata file created: regulation-metadata.json"
            echo "ğŸ“… Last updated: $(cat regulation-metadata.json | jq -r '.lastUpdated')"
            echo "ğŸ”¢ Number of regulations: $(cat regulation-metadata.json | jq '.regulations | length')"
          else
            echo "âŒ Metadata file not found!"
            exit 1
          fi
          
      - name: ğŸ”¨ Build and test
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ—ï¸ Building application..."
          npm run build
          
          echo "ğŸ§ª Running tests..."
          npm run test
          
      - name: ğŸ” Validate generated content
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ” Validating generated content..."
          
          # Validate questions JSON structure
          echo "ğŸ“‹ Validating questions structure..."
          node -e "
            const questions = require('./public/locales/en/questions.json');
            if (!questions.intakeQuestions) {
              console.error('âŒ Missing intakeQuestions object');
              process.exit(1);
            }
            
            const questionCount = Object.keys(questions.intakeQuestions).length;
            console.log('âœ… Questions validation passed (' + questionCount + ' questions)');
            
            // Check each question has required structure
            for (const [key, q] of Object.entries(questions.intakeQuestions)) {
              if (!q.question || !Array.isArray(q.options) || q.options.length < 2) {
                console.error('âŒ Invalid question structure at index ' + key);
                process.exit(1);
              }
            }
            console.log('âœ… All questions have valid structure');
          "
          
          # Validate logic file has required exports
          echo "âš™ï¸ Validating logic file..."
          node -e "
            const fs = require('fs');
            const logicContent = fs.readFileSync('./components/logic/logic.tsx', 'utf8');
            
            if (!logicContent.includes('generatePersonalizedTasks')) {
              console.error('âŒ Logic file missing generatePersonalizedTasks function');
              process.exit(1);
            }
            
            if (!logicContent.includes('export')) {
              console.error('âŒ Logic file missing export statement');
              process.exit(1);
            }
            
            console.log('âœ… Logic file validation passed');
          "
          
      - name: ğŸ“Š Generate update summary
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“Š Generating update summary..."
          
          # Create summary file
          cat > update_summary.md << EOF
          # ğŸ¤– Automated Regulations Update Summary
          
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Regulations Source**: $REGULATIONS_URL
          
          ## ğŸ“‹ Files Updated
          - âœ… Questions: \`public/locales/en/questions.json\`
          - âœ… Logic: \`components/logic/logic.tsx\`
          - âœ… Metadata: \`regulation-metadata.json\`
          
          ## ğŸ“Š Statistics
          - **Questions Generated**: $(cat public/locales/en/questions.json | jq '.intakeQuestions | length')
          - **Regulations Processed**: $(cat regulation-metadata.json | jq '.regulations | length')
          - **Last Updated**: $(cat regulation-metadata.json | jq -r '.lastUpdated')
          
          ## ğŸ” Generated Questions
          $(cat public/locales/en/questions.json | jq -r '.intakeQuestions | to_entries[] | "- **Q\(.key + 1)**: \(.value.question)"')
          
          ---
          *This update was generated automatically by GitHub Actions*
          EOF
          
          echo "ğŸ“„ Update summary created:"
          cat update_summary.md
          
      - name: ğŸ“¤ Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add all relevant files
          git add components/logic/logic.tsx
          git add public/locales/en/questions.json
          git add regulation-metadata.json
          git add previous_regulations.html
          git add update_summary.md
          
          # Create detailed commit message
          cat > commit_message.txt << EOF
          ğŸ¤– Auto-update: Regulations, questions and logic updated
          
          - Generated $(cat public/locales/en/questions.json | jq '.intakeQuestions | length') intake questions
          - Updated logic based on $(cat regulation-metadata.json | jq '.regulations | length') regulations
          - Source: $REGULATIONS_URL
          - Updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          Files updated:
          - public/locales/en/questions.json
          - components/logic/logic.tsx
          - regulation-metadata.json
          EOF
          
          git commit -F commit_message.txt
          git push
          
          echo "âœ… Changes committed and pushed successfully!"
          
      - name: ğŸ‰ Success notification
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ‰ Regulations update completed successfully!"
          echo "ğŸ“‹ Questions: $(cat public/locales/en/questions.json | jq '.intakeQuestions | length') generated"
          echo "âš™ï¸ Logic: Updated based on current regulations"
          echo "ğŸ“Š Metadata: Saved for future comparisons"
          
      - name: â„¹ï¸ No changes notification
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸ No changes detected in regulations"
          echo "ğŸ“‹ Current questions and logic remain up to date"